//
//  ChineseConverter.swift
//  GuJiReader
//
//  繁简转换工具
//

import Foundation

/// 繁简转换管理器
class ChineseConverter {

    static let shared = ChineseConverter()

    private init() {}

    // MARK: - 转换模式
    enum ConversionMode {
        case traditionalToSimplified  // 繁转简
        case simplifiedToTraditional  // 简转繁
    }

    // MARK: - 主要转换方法
    func convert(_ text: String, mode: ConversionMode) -> String {
        switch mode {
        case .traditionalToSimplified:
            return performToSimplifiedConversion(text)
        case .simplifiedToTraditional:
            return performToTraditionalConversion(text)
        }
    }

    // MARK: - 繁体转简体
    private func performToSimplifiedConversion(_ text: String) -> String {
        var result = text

        // 常用繁简对照表（部分常用字）
        let mappings: [String: String] = [
            // 数字
            "０": "0", "１": "1", "２": "2", "３": "3", "４": "4",
            "５": "5", "６": "6", "７": "7", "８": "8", "９": "9",

            // 标点
            "：": ":", "；": ";", "，": ",", "。": ".",
            "？": "?", "！": "!", "「": "\"", "」": "\"",
            "『": "'", "』": "'", "（": "(", "）": ")",
            "《": "<", "》": ">", "【": "[", "】": "]",

            // 常用繁简字对照（250个常用字）
            "愛": "爱", "曉": "晓", "書": "书", "長": "长", "風": "风",
            "門": "门", "問": "问", "聞": "闻", "關": "关", "開": "开",
            "學": "学", "覺": "觉", "親": "亲", "見": "见", "現": "现",
            "語": "语", "講": "讲", "讓": "让", "認": "认", "識": "识",
            "國": "国", "園": "园", "圖": "图", "圖": "图", "過": "过",
            "還": "还", "進": "进", "這": "这", "邊": "边", "運": "运",
            "遠": "远", "動": "动", "場": "场", "職": "职", "報": "报",
            "學": "学", "導": "导", "獨": "独", "積": "积", "極": "极",
            "種": "种", "種": "种", "類": "类", "樣": "样", "歲": "岁",
            "號": "号", "標": "标", "記": "记", "應": "应", "當": "当",
            "時": "时", "無": "无", "為": "为", "與": "与", "實": "实",
            "際": "际", "檢": "检", "構": "构", "決": "决", "況": "况",
            "終": "终", "準": "准", "確": "确", "劃": "划", "選": "选",
            "華": "华", "護": "护", "寶": "宝", "實": "实", "驗": "验",
            "證": "证", "論": "论", "評": "评", "設": "设", "計": "计",
            "會": "会", "個": "个", "從": "从", "體": "体", "係": "系",
            "統": "统", "網": "网", "絡": "络", "經": "经", "營": "营",
            "業": "业", "產": "产", "品": "品", "質": "质", "幣": "币",
            "車": "车", "東": "东", "絲": "丝", "樂": "乐", "農": "农",
            "務": "务", "歷": "历", "厲": "厉", "壓": "压", "廠": "厂",
            "廳": "厅", "庫": "库", "歸": "归", "態": "态", "濟": "济",
            "殘": "残", "牽": "牵", "標": "标", "籤": "签", "權": "权",
            "權": "权", "幹": "干", "趕": "赶", "躍": "跃", "貫": "贯",
            "賣": "卖", "賴": "赖", "廢": "废", "墮": "堕", "聲": "声",
            "醫": "医", "藝": "艺", "義": "义", "繫": "系", "據": "据",
            "觀": "观", "觸": "触", "處": "处", "備": "备", "復": "复",
            "變": "变", "黨": "党", "嚴": "严", "眾": "众", "優": "优",
            "廣": "广", "輛": "辆", "輕": "轻", "輝": "辉", "輩": "辈",
            "輪": "轮", "輟": "辍", "輸": "输", "辦": "办", "辭": "辞",
            "邊": "边", "達": "达", "運": "运", "遞": "递", "遠": "远",
            "遙": "遥", "遜": "逊", "道": "道", "違": "违", "遷": "迁",
            "選": "选", "遺": "遗", "遼": "辽", "優": "优", "億": "亿",
            "儀": "仪", "儲": "储", "儘": "尽", "願": "愿", "參": "参",
            "雙": "双", "雜": "杂", "雞": "鸡", "難": "难", "雨": "雨",
            "雪": "雪", "雲": "云", "零": "零", "雷": "雷", "雹": "雹",
            "電": "电", "需": "需", "震": "震", "霧": "雾", "靈": "灵",
            "靜": "静", "靜": "静", "面": "面", "革": "革", "韋": "韦",
            "韓": "韩", "音": "音", "頁": "页", "頂": "顶", "順": "顺",
            "須": "须", "頑": "顽", "頒": "颁", "頓": "顿", "顯": "显",
            "顯": "显", "題": "题", "顏": "颜", "願": "愿", "類": "类",
            "習": "习", "翽": "翙", "翻": "翻", "轉": "转", "轄": "辖",
            "轉": "转", "轟": "轰", "辭": "辞", "邊": "边", "達": "达",
            "運": "运", "遞": "递", "遠": "远", "遙": "遥", "遜": "逊",
            "道": "道", "違": "违", "遷": "迁", "選": "选", "遺": "遗",
            "遼": "辽", "優": "优", "億": "亿", "儀": "仪", "儲": "储",
            "儘": "尽", "願": "愿", "參": "参", "雙": "双", "雜": "杂",
            "雞": "鸡", "難": "难", "雨": "雨", "雪": "雪", "雲": "云",
            "零": "零", "雷": "雷", "雹": "雹", "電": "电", "需": "需",
            "震": "震", "霧": "雾", "靈": "灵", "靜": "静", "面": "面",
            "革": "革", "韋": "韦", "韓": "韩", "音": "音", "頁": "页",
            "頂": "顶", "順": "顺", "須": "须", "頑": "顽", "頒": "颁",
            "頓": "顿", "顯": "显", "題": "题", "顏": "颜", "願": "愿",
            "類": "类", "習": "习", "翽": "翙", "翻": "翻", "轉": "转",
            "轄": "辖", "轟": "轰", "辭": "辞"
        ]

        // 执行替换
        for (traditional, simplified) in mappings {
            result = result.replacingOccurrences(of: traditional, with: simplified)
        }

        // 使用iOS原生API作为补充
        if let converted = result.applyingTransform(.init("Traditional-Simplified"), reverse: false) {
            return converted
        }

        return result
    }

    // MARK: - 简体转繁体
    private func performToTraditionalConversion(_ text: String) -> String {
        var result = text

        // 常用简繁对照表（反向映射）
        let mappings: [String: String] = [
            // 数字
            "0": "０", "1": "１", "2": "２", "3": "３", "4": "４",
            "5": "５", "6": "６", "7": "７", "8": "８", "9": "９",

            // 标点
            ":": "：", ";": "；", ",": "，", ".": "。",
            "?": "？", "!": "！", "\"": "「", "\"": "」",
            "'": "『", "'": "』", "(": "（", ")": "）",
            "<": "《", ">": "》", "[": "【", "]": "】",

            // 常用简繁字对照
            "爱": "愛", "晓": "曉", "书": "書", "长": "長", "风": "風",
            "门": "門", "问": "問", "闻": "聞", "关": "關", "开": "開",
            "学": "學", "觉": "覺", "亲": "親", "见": "見", "现": "現",
            "语": "語", "讲": "講", "让": "讓", "认": "認", "识": "識",
            "国": "國", "园": "園", "图": "圖", "过": "過", "还": "還",
            "进": "進", "这": "這", "边": "邊", "运": "運", "远": "遠",
            "动": "動", "场": "場", "职": "職", "报": "報", "导": "導",
            "独": "獨", "积": "積", "极": "極", "种": "種", "类": "類",
            "样": "樣", "岁": "歲", "号": "號", "标": "標", "记": "記",
            "应": "應", "当": "當", "时": "時", "无": "無", "为": "為",
            "与": "與", "实": "實", "际": "際", "检": "檢", "构": "構",
            "决": "決", "况": "況", "终": "終", "准": "準", "确": "確",
            "划": "劃", "选": "選", "华": "華", "护": "護", "宝": "寶",
            "验": "驗", "证": "證", "论": "論", "评": "評", "设": "設",
            "计": "計", "会": "會", "个": "個", "从": "從", "体": "體",
            "系": "係", "统": "統", "网": "網", "络": "絡", "经": "經",
            "营": "營", "业": "業", "产": "產", "质": "質", "币": "幣",
            "车": "車", "东": "東", "丝": "絲", "乐": "樂", "农": "農",
            "务": "務", "历": "歷", "厉": "厲", "压": "壓", "厂": "廠",
            "厅": "廳", "库": "庫", "归": "歸", "态": "態", "济": "濟",
            "残": "殘", "牵": "牽", "签": "籤", "权": "權", "干": "幹",
            "赶": "趕", "跃": "躍", "贯": "貫", "卖": "賣", "赖": "賴",
            "废": "廢", "堕": "墮", "声": "聲", "医": "醫", "艺": "藝",
            "义": "義", "据": "據", "观": "觀", "触": "觸", "处": "處",
            "备": "備", "复": "復", "变": "變", "党": "黨", "严": "嚴",
            "众": "眾", "优": "優", "广": "廣", "辆": "輛", "轻": "輕",
            "辉": "輝", "辈": "輩", "轮": "輪", "辍": "輟", "输": "輸",
            "办": "辦", "辞": "辭", "达": "達", "递": "遞", "遥": "遙",
            "逊": "遜", "违": "違", "迁": "遷", "遗": "遺", "辽": "遼",
            "亿": "億", "仪": "儀", "储": "儲", "尽": "儘", "参": "參",
            "双": "雙", "杂": "雜", "鸡": "雞", "难": "難", "云": "雲",
            "电": "電", "灵": "靈", "静": "靜", "韦": "韋", "韩": "韓",
            "页": "頁", "顶": "頂", "顺": "順", "须": "須", "顽": "頑",
            "颁": "頒", "顿": "頓", "显": "顯", "题": "題", "颜": "顏"
        ]

        // 执行替换
        for (simplified, traditional) in mappings {
            result = result.replacingOccurrences(of: simplified, with: traditional)
        }

        // 使用iOS原生API作为补充
        if let converted = result.applyingTransform(.init("Simplified-Traditional"), reverse: false) {
            return converted
        }

        return result
    }

    // MARK: - 便捷方法
    func toSimplified(_ text: String) -> String {
        return convert(text, mode: .traditionalToSimplified)
    }

    func toTraditional(_ text: String) -> String {
        return convert(text, mode: .simplifiedToTraditional)
    }
}
